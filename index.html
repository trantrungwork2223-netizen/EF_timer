<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>EF Tracker ‚Äì Spotify Mode</title>
  <style>
    :root {
      --spotify-green: #1DB954;
      --bg-dark: #050505;
      --bg-card: #121212;
      --bg-input: #000000;
      --text-main: #F9FAFB;
      --text-muted: #9CA3AF;
      --danger: #F97373;
      --radius: 14px;
      --shadow: 0 14px 35px rgba(0,0,0,0.7);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px 16px 32px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 960px;
    }

    header {
      margin-bottom: 18px;
    }

    h1 {
      font-size: 24px;
      color: var(--spotify-green);
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    #today {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* Pause bar */
    .pause-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 18px;
    }

    button {
      border: none;
      cursor: pointer;
      font-size: 13px;
      border-radius: var(--radius);
      padding: 7px 13px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.15s ease;
      white-space: nowrap;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-green {
      background: var(--spotify-green);
      color: #000;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(29, 185, 84, 0.4);
    }

    .btn-dark {
      background: #1F2933;
      color: var(--text-main);
    }

    .btn-outline-green {
      background: transparent;
      color: var(--spotify-green);
      border: 1px solid var(--spotify-green);
      padding-inline: 16px;
    }

    .btn-red {
      background: #7F1D1D;
      color: #FEE2E2;
    }

    /* Add project row */
    .add-row {
      display: grid;
      grid-template-columns: minmax(0,2fr) 90px 150px auto;
      gap: 8px;
      background: rgba(18,18,18,0.96);
      border-radius: 18px;
      padding: 10px 14px;
      margin-bottom: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.7);
    }

    input[type="text"],
    input[type="number"] {
      background: var(--bg-input);
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 7px 10px;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    input::placeholder {
      color: #6B7280;
    }

    input:focus {
      border-color: var(--spotify-green);
      box-shadow: 0 0 0 1px rgba(29,185,84,0.5);
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #111827;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 7px 10px;
      font-size: 13px;
      color: var(--text-main);
      cursor: pointer;
    }

    /* Projects grid */
    #projects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .project {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 12px 14px 10px;
      box-shadow: var(--shadow);
      border: 1px solid #1F2933;
    }

    .proj-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .proj-main {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .logo-circle {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      overflow: hidden;
      background: #020617;
      border: 1px solid #4B5563;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 16px;
    }

    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .proj-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .proj-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .proj-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .proj-meta {
      font-size: 11px;
      text-align: right;
      color: var(--text-muted);
    }

    .pill {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #4B5563;
      background: #020617;
      margin-bottom: 2px;
    }

    .timer-box {
      margin-top: 8px;
      background: #020617;
      border-radius: 16px;
      padding: 7px 10px;
      border: 1px solid #111827;
    }

    .timer {
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 26px;
      text-align: center;
      letter-spacing: 0.15em;
      color: var(--spotify-green);
    }

    .timer.low {
      color: #FBBF24;
    }

    .timer.ot {
      color: #22C55E;
    }

    .proj-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
    }

    .footer-left {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tasks {
      margin-top: 8px;
      background: #18181B;
      border-radius: 14px;
      padding: 7px 8px;
      border: 1px solid #27272F;
      font-size: 12px;
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .task-add-row {
      display: flex;
      gap: 6px;
      margin-bottom: 5px;
    }

    .task-add-row input {
      font-size: 11px;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--text-main);
    }

    .task-add-row button {
      font-size: 11px;
      padding: 4px 8px;
    }

    .task-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      border-bottom: 1px solid #27272F;
    }

    .task-row:last-child {
      border-bottom: none;
    }

    .task-main {
      max-width: 70%;
    }

    .task-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .task-actions button {
      font-size: 10px;
      padding: 2px 6px;
    }

    @media (max-width: 700px) {
      .add-row {
        grid-template-columns: 1fr 1fr;
        grid-auto-rows: auto;
      }
      .add-row > *:nth-child(3),
      .add-row > *:nth-child(4) {
        grid-column: span 2;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>EF Tracker ‚Äì Spotify Mode</h1>
      <div class="subtitle">Focus timer with projects, tasks, pause logging & CSV report.</div>
      <div id="today"></div>
    </header>

    <!-- Pause buttons -->
    <div class="pause-bar">
      <button class="btn-outline-green" onclick="startPause('Lunch')">üçΩ Lunch</button>
      <button class="btn-outline-green" onclick="startPause('Bathroom')">üöª Bathroom</button>
      <button class="btn-outline-green" onclick="startPause('Personal')">üïò Personal</button>
    </div>

    <!-- Add project row -->
    <div class="add-row">
      <input id="pname" type="text" placeholder="T√™n d·ª± √°n (v√≠ d·ª•: Oddspark)" />
      <input id="palloc" type="number" min="1" max="100" placeholder="% EF (vd: 40)" />
      <label class="file-label">
        Logo
        <input id="plogo" type="file" accept="image/*">
      </label>
      <button class="btn-green" onclick="addProject()">+ Add</button>
    </div>

    <!-- Projects -->
    <div id="projects"></div>

    <!-- Export -->
    <button class="btn-dark" onclick="exportCSV()">üìé Export CSV Report</button>
  </div>

  <script>
    const BASE_SECONDS = 8 * 60 * 60;
    let activeProjectId = null;

    function todayString() {
      return new Date().toLocaleDateString("vi-VN", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });
    }

    document.getElementById("today").textContent = "Today: " + todayString();

    // ---------- Storage ----------
    let data = JSON.parse(localStorage.getItem("EF_DATA_SPOT") || "[]");
    let pauseLogs = JSON.parse(localStorage.getItem("EF_PAUSE_LOGS") || "[]");
    let activePause = null;

    function saveData() {
      localStorage.setItem("EF_DATA_SPOT", JSON.stringify(data));
    }

    function savePauseLogs() {
      localStorage.setItem("EF_PAUSE_LOGS", JSON.stringify(pauseLogs));
    }

    // ---------- Utils ----------
    function fmtTime(sec) {
      sec = Math.max(0, Math.round(sec));
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    function minutes(sec) {
      return Math.round(sec / 60);
    }

    function projectUsedSeconds(p) {
      return Math.max(0, p.totalSeconds - p.remainingSeconds);
    }

    async function fileToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }

    // ---------- Add project ----------
    async function addProject() {
      const nameInput = document.getElementById("pname");
      const allocInput = document.getElementById("palloc");
      const logoInput = document.getElementById("plogo");

      const name = nameInput.value.trim();
      const alloc = parseFloat(allocInput.value);

      if (!name || isNaN(alloc) || alloc <= 0) {
        alert("Vui l√≤ng nh·∫≠p t√™n d·ª± √°n v√† % EF h·ª£p l·ªá.");
        return;
      }

      const extraSeconds = (alloc / 100) * BASE_SECONDS;
      let logoBase64 = "";

      if (logoInput.files && logoInput.files[0]) {
        logoBase64 = await fileToBase64(logoInput.files[0]);
      }

      // N·∫øu tr√πng t√™n d·ª± √°n ‚áí c·ªông th√™m v√†o project c≈©
      const existing = data.find(
        (p) => p.name.toLowerCase() === name.toLowerCase()
      );

      if (existing) {
        existing.allocation += alloc;
        existing.allocatedSeconds += extraSeconds;
        existing.totalSeconds += extraSeconds;
        existing.remainingSeconds += extraSeconds;
        if (logoBase64) existing.logo = logoBase64;
      } else {
        data.push({
          id: crypto.randomUUID(),
          name,
          allocation: alloc,
          allocatedSeconds: extraSeconds,
          totalSeconds: extraSeconds,
          remainingSeconds: extraSeconds,
          logo: logoBase64,
          tasks: [],
          _lastTick: null,
        });
      }

      nameInput.value = "";
      allocInput.value = "";
      logoInput.value = "";

      saveData();
      render();
    }

    // ---------- Pause handling ----------
    function startPause(type) {
      // stop all project timers
      activeProjectId = null;
      data.forEach((p) => {
        p._lastTick = null;
      });

      activePause = {
        type,
        start: Date.now(),
      };

      alert(type + " pause started");
    }

    // ---------- Start project ----------
    function startProject(projectId) {
      // N·∫øu ƒëang trong tr·∫°ng th√°i pause => ghi log l·∫°i r·ªìi clear
      if (activePause) {
        const now = Date.now();
        const dur = (now - activePause.start) / 1000;
        pauseLogs.push({
          id: crypto.randomUUID(),
          type: activePause.type,
          start: new Date(activePause.start),
          end: new Date(now),
          durationSec: dur,
          date: new Date().toISOString().split("T")[0],
        });
        activePause = null;
        savePauseLogs();
      }

      const now2 = Date.now();
      activeProjectId = projectId;
      data.forEach((p) => {
        if (p.id === projectId) {
          p._lastTick = now2;
        } else {
          p._lastTick = null;
        }
      });
      saveData();
      render();
    }

    // ---------- Delete project ----------
    function deleteProject(projectId) {
      if (!confirm("X√≥a project n√†y v√† to√†n b·ªô tasks?")) return;
      data = data.filter((p) => p.id !== projectId);
      if (activeProjectId === projectId) activeProjectId = null;
      saveData();
      render();
    }

    // ---------- Add task ----------
    function addTask(projectId) {
      const nameInput = document.getElementById(`task_${projectId}`);
      const estInput = document.getElementById(`est_${projectId}`);

      const name = nameInput.value.trim();
      const estMin = parseFloat(estInput.value);

      if (!name || isNaN(estMin) || estMin <= 0) return;

      const proj = data.find((p) => p.id === projectId);
      if (!proj) return;

      proj.tasks.push({
        id: crypto.randomUUID(),
        name,
        effEst: estMin * 60,
        effActual: 0,
      });

      nameInput.value = "";
      estInput.value = "";

      saveData();
      render();
    }

    // ---------- Delete task ----------
    function deleteTask(projectId, taskId) {
      const proj = data.find((p) => p.id === projectId);
      if (!proj) return;
      proj.tasks = proj.tasks.filter((t) => t.id !== taskId);
      saveData();
      render();
    }

    // ---------- Add OT ----------
    function addOT(projectId) {
      const minStr = prompt("C·ªông th√™m bao nhi√™u ph√∫t OT?", "30");
      if (minStr === null) return;
      const mins = parseFloat(minStr);
      if (isNaN(mins) || mins <= 0) return;

      const proj = data.find((p) => p.id === projectId);
      if (!proj) return;

      const sec = mins * 60;
      proj.totalSeconds += sec;
      proj.remainingSeconds += sec;

      saveData();
      render();
    }

    // ---------- Timer loop ----------
    setInterval(() => {
      if (!activeProjectId) return;
      const proj = data.find((p) => p.id === activeProjectId);
      if (!proj) return;

      const now = Date.now();
      if (!proj._lastTick) {
        proj._lastTick = now;
        return;
      }

      const diff = (now - proj._lastTick) / 1000;
      if (diff < 0.5) return;
      proj._lastTick = now;

      proj.remainingSeconds -= diff;
      if (proj.remainingSeconds <= 0) {
        proj.remainingSeconds = 0;
        activeProjectId = null;
      }

      // allocate actual time cho task cu·ªëi c√πng
      if (proj.tasks.length) {
        proj.tasks[proj.tasks.length - 1].effActual += diff;
      }

      saveData();
      render();
    }, 800);

    // ---------- Export CSV ----------
    function exportCSV() {
      const rows = ["Project,Task,Type,Est(min),Actual(min)"];

      data.forEach((p) => {
        const type = p.totalSeconds > p.allocatedSeconds ? "OT" : "Formal";
        if (!p.tasks.length) {
          rows.push(
            [
              p.name,
              "(no task)",
              type,
              0,
              minutes(projectUsedSeconds(p)),
            ].join(",")
          );
        } else {
          p.tasks.forEach((t) => {
            rows.push(
              [
                p.name,
                t.name,
                type,
                minutes(t.effEst),
                minutes(t.effActual),
              ].join(",")
            );
          });
        }
      });

      rows.push("");
      rows.push("Pause Logs");
      rows.push("Type,Date,Duration(min)");

      pauseLogs.forEach((l) => {
        rows.push(
          [l.type, l.date, minutes(l.durationSec)].join(",")
        );
      });

      const blob = new Blob([rows.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ef_report.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- Render ----------
    function render() {
      const container = document.getElementById("projects");
      container.innerHTML = "";

      if (!data.length) return;

      data.forEach((p) => {
        const card = document.createElement("article");
        card.className = "project";

        const header = document.createElement("div");
        header.className = "proj-header";

        const left = document.createElement("div");
        left.className = "proj-main";

        const logo = document.createElement("div");
        logo.className = "logo-circle";
        if (p.logo) {
          const img = document.createElement("img");
          img.src = p.logo;
          logo.appendChild(img);
        } else {
          logo.textContent = p.name.charAt(0).toUpperCase();
        }

        const title = document.createElement("div");
        title.className = "proj-title";

        const nameEl = document.createElement("div");
        nameEl.className = "proj-name";
        nameEl.textContent = p.name;

        const subEl = document.createElement("div");
        subEl.className = "proj-sub";
        subEl.textContent = `${p.allocation}% c·ªßa 8h ‚Ä¢ Base ${minutes(
          p.allocatedSeconds
        )} ph√∫t`;

        title.appendChild(nameEl);
        title.appendChild(subEl);

        left.appendChild(logo);
        left.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "proj-meta";
        const used = minutes(projectUsedSeconds(p));
        const remaining = minutes(p.remainingSeconds);
        meta.innerHTML = `<div class="pill">${used}m used</div><div>${remaining}m left</div>`;

        header.appendChild(left);
        header.appendChild(meta);

        const timerBox = document.createElement("div");
        timerBox.className = "timer-box";

        const timer = document.createElement("div");
        timer.className = "timer";
        timer.textContent = fmtTime(p.remainingSeconds);

        const lowThreshold = p.totalSeconds * 0.1;
        if (p.remainingSeconds <= lowThreshold && p.remainingSeconds > 0) {
          timer.classList.add("low");
        }
        if (p.totalSeconds > p.allocatedSeconds) {
          timer.classList.add("ot");
        }

        timerBox.appendChild(timer);

        const footer = document.createElement("div");
        footer.className = "proj-footer";

        const leftButtons = document.createElement("div");
        leftButtons.className = "footer-left";

        const startBtn = document.createElement("button");
        startBtn.className = "btn-dark";
        startBtn.textContent =
          activeProjectId === p.id ? "Running‚Ä¶" : "Start";
        startBtn.onclick = () => startProject(p.id);

        const otBtn = document.createElement("button");
        otBtn.className = "btn-dark";
        otBtn.textContent = "+ OT";
        otBtn.onclick = () => addOT(p.id);

        const delBtn = document.createElement("button");
        delBtn.className = "btn-red";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => deleteProject(p.id);

        leftButtons.appendChild(startBtn);
        leftButtons.appendChild(otBtn);
        leftButtons.appendChild(delBtn);

        const rightInfo = document.createElement("div");
        rightInfo.style.fontSize = "11px";
        rightInfo.style.color = "#9CA3AF";
        rightInfo.innerHTML = `${p.tasks.length} task(s)<br/>Total ${minutes(
          p.totalSeconds
        )}m`;

        footer.appendChild(leftButtons);
        footer.appendChild(rightInfo);

        const tasks = document.createElement("div");
        tasks.className = "tasks";

        const tHeader = document.createElement("div");
        tHeader.className = "tasks-header";
        tHeader.innerHTML = `<span>Tasks</span><span>${p.tasks.length} item</span>`;

        const addRow = document.createElement("div");
        addRow.className = "task-add-row";
        addRow.innerHTML = `
          <input id="task_${p.id}" type="text" placeholder="T√™n task..." />
          <input id="est_${p.id}" type="number" placeholder="Est (ph√∫t)" style="max-width:100px" />
          <button class="btn-green" onclick="addTask('${p.id}')">+</button>
        `;

        tasks.appendChild(tHeader);
        tasks.appendChild(addRow);

        p.tasks.forEach((t) => {
          const row = document.createElement("div");
          row.className = "task-row";

          const mainTask = document.createElement("div");
          mainTask.className = "task-main";

          const nameTask = document.createElement("div");
          nameTask.className = "task-name";
          nameTask.textContent = t.name;

          const metaTask = document.createElement("div");
          metaTask.className = "task-meta";
          metaTask.textContent = `Est ${minutes(
            t.effEst
          )}m ‚Ä¢ Actual ${minutes(t.effActual)}m`;

          mainTask.appendChild(nameTask);
          mainTask.appendChild(metaTask);

          const actions = document.createElement("div");
          actions.className = "task-actions";

          const delTaskBtn = document.createElement("button");
          delTaskBtn.className = "btn-red";
          delTaskBtn.textContent = "Del";
          delTaskBtn.onclick = () => deleteTask(p.id, t.id);

          actions.appendChild(delTaskBtn);

          row.appendChild(mainTask);
          row.appendChild(actions);

          tasks.appendChild(row);
        });

        card.appendChild(header);
        card.appendChild(timerBox);
        card.appendChild(footer);
        card.appendChild(tasks);

        container.appendChild(card);
      });
    }

    render();
  </script>
</body>
</html>
