<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>EF Tracker ‚Äì Spotify Mode</title>

<style>
/* ---------- Spotify Theme ---------- */
:root {
  --spotify-green: #1DB954;
  --bg-dark: #0B0B0B;
  --bg-card: #121212;
  --text-light: #F2F2F2;
  --text-muted: #9DA0A6;
  --danger: #ff4d4d;
  --radius: 14px;
  --shadow: 0 10px 25px rgba(0,0,0,0.6);
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg-dark);
  color: var(--text-light);
  padding: 20px;
  display: flex;
  justify-content: center;
}

.app {
  width: 100%;
  max-width: 880px;
}

h1 {
  font-size: 22px;
  font-weight: 600;
  color: var(--spotify-green);
  margin-bottom: 6px;
}

.subtitle {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 18px;
}

/* Add Project UI */
.add-row {
  display: grid;
  grid-template-columns: 1fr 100px 140px auto;
  gap: 8px;
  background: var(--bg-card);
  padding: 10px 14px;
  border-radius: var(--radius);
  margin-bottom: 16px;
}

input, .file-label {
  background: black;
  border: 1px solid #333;
  border-radius: var(--radius);
  padding: 7px 10px;
  font-size: 13px;
  color: var(--text-light);
}

.file-label {
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

input[type=file] { display:none; }

/* Buttons */
button {
  border: none;
  padding: 7px 13px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 13px;
}

.btn-green {
  background: var(--spotify-green);
  color: #000;
}
.btn-dark {
  background: #222;
  color: var(--text-light);
}
.btn-red {
  background: var(--danger);
  color: #000;
}
.btn-pause {
  background: #111;
  border: 1px solid var(--spotify-green);
  color: var(--spotify-green);
}

/* Cards */
.project {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo {
  width:28px;
  height:28px;
  border-radius:50%;
  overflow:hidden;
  border:1px solid #333;
}

.logo img { width:100%; height:100%; object-fit:cover; }

.pname { font-size:14px; font-weight:600; }

.timer {
  margin-top: 6px;
  padding: 6px;
  text-align:center;
  font-size:28px;
  background:black;
  border-radius: var(--radius);
  font-family: monospace;
  letter-spacing: 0.1em;
}

/* Tasks */
.task-box {
  background:#171717;
  border-radius:var(--radius);
  margin-top:10px;
  padding:8px;
}

.task-row {
  display:flex;
  justify-content:space-between;
  font-size:12px;
  padding:4px 0;
  border-bottom:1px solid #222;
}
.task-row:last-child { border:none; }

/* Pause buttons Row */
.pausebar {
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:20px;
}
</style>
</head>

<body>
<div class="app">
  <h1>EF Tracker ‚Äì Spotify Mode</h1>
  <div class="subtitle">Focus timer with tasks, pause logging, CSV report.</div>
  <div id="today" class="subtitle"></div>

  <!-- Pause Buttons -->
  <div class="pausebar">
    <button class="btn-pause" onclick="startPause('Lunch')">üçΩ Lunch</button>
    <button class="btn-pause" onclick="startPause('Bathroom')">üöª Bathroom</button>
    <button class="btn-pause" onclick="startPause('Personal')">üïò Personal</button>
  </div>

  <!-- Add project UI -->
  <div class="add-row">
    <input id="pname" placeholder="T√™n d·ª± √°n" />
    <input id="palloc" type="number" placeholder="%EF" />
    <label class="file-label">Logo
      <input id="plogo" type="file" accept="image/*" />
    </label>
    <button class="btn-green" onclick="addProject()">+ Add</button>
  </div>

  <!-- Projects -->
  <div id="projects"></div>

  <!-- Export -->
  <button class="btn-dark" onclick="exportCSV()">üìé Export CSV Report</button>
</div>

<script>
/* ---------- GLOBAL STATE ---------- */
let BASE_SECONDS = 8 * 60 * 60;
let activeProjectId = null;

let data = JSON.parse(localStorage.getItem("EF_DATA_SPOT") || "[]");
let pauseLogs = JSON.parse(localStorage.getItem("EF_PAUSE_LOGS") || "[]");
let activePause = null;

function saveData(){ localStorage.setItem("EF_DATA_SPOT", JSON.stringify(data)); }
function savePauseLogs(){ localStorage.setItem("EF_PAUSE_LOGS", JSON.stringify(pauseLogs)); }

/* ---------- UTIL ---------- */
document.getElementById("today").textContent =
  "Today: " + new Date().toLocaleDateString("vi-VN");

function fmt(sec){
  sec = Math.max(0, sec);
  let h = Math.floor(sec/3600),
      m = Math.floor((sec%3600)/60),
      s = Math.floor(sec%60);
  return [h,m,s].map(v=>String(v).padStart(2,"0")).join(":");
}

/* ---------- ADD PROJECT ---------- */
async function fileToBase64(file){
  return new Promise(res=>{
    let r = new FileReader();
    r.onload = e=>res(e.target.result);
    r.readAsDataURL(file);
  });
}

async function addProject(){
  let name=document.getElementById("pname").value.trim();
  let alloc=parseFloat(document.getElementById("palloc").value);
  let logoInput=document.getElementById("plogo").files[0];

  if(!name || isNaN(alloc)){ alert("Nh·∫≠p t√™n v√† % EF"); return;}

  let sec = (alloc/100)*BASE_SECONDS;
  let base64 = "";
  if(logoInput) base64 = await fileToBase64(logoInput);

  data.push({
    id:crypto.randomUUID(),
    name,
    allocation:alloc,
    totalSeconds:sec,
    remainingSeconds:sec,
    logo:base64,
    tasks:[],
    _lastTick:null
  });

  saveData();
  render();
}

/* ---------- START PROJECT ---------- */
function startProject(id){
  // n·∫øu ƒëang trong pause ‚Üí log pause tr∆∞·ªõc
  if(activePause){
    let now=Date.now();
    let dur=(now-activePause.start)/1000;
    pauseLogs.push({
      id:crypto.randomUUID(),
      type:activePause.type,
      start:new Date(activePause.start),
      end:new Date(now),
      durationSec:dur,
      date: new Date().toISOString().split("T")[0]
    });
    activePause=null;
    savePauseLogs();
  }

  let now2=Date.now();
  activeProjectId=id;
  data.forEach(p=>{
    if(p.id===id) p._lastTick=now2;
    else p._lastTick=null;
  });
  saveData();
  render();
}

/* ---------- DELETE PROJECT ---------- */
function deleteProject(id){
  if(!confirm("X√≥a to√†n b·ªô project?")) return;
  data=data.filter(p=>p.id!==id);
  if(activeProjectId===id) activeProjectId=null;
  saveData();
  render();
}

/* ---------- ADD TASK ---------- */
function addTask(pid){
  let name=document.getElementById(`task_${pid}`).value.trim();
  let est=parseFloat(document.getElementById(`est_${pid}`).value);
  if(!name || isNaN(est)) return;

  let pr=data.find(p=>p.id===pid);
  pr.tasks.push({
    id:crypto.randomUUID(),
    name,
    effEst:est*60,
    effActual:0
  });
  saveData();
  render();
}

/* ---------- DELETE TASK ---------- */
function deleteTask(pid,tid){
  let p=data.find(p=>p.id===pid);
  p.tasks=p.tasks.filter(t=>t.id!==tid);
  saveData();
  render();
}

/* ---------- PAUSE LOGGING ---------- */
function startPause(type){
  activeProjectId=null;
  data.forEach(p=>p._lastTick=null);

  activePause={
    type,
    start:Date.now()
  };
  alert(type + " pause started");
}

/* ---------- TIMER LOOP ---------- */
setInterval(()=>{
  if(!activeProjectId) return;
  let now=Date.now();
  let p=data.find(x=>x.id===activeProjectId);
  if(!p||!p._lastTick) return;
  let diff=(now-p._lastTick)/1000;
  p._lastTick=now;
  p.remainingSeconds-=diff;
  if(p.remainingSeconds<0) p.remainingSeconds=0;

  // allocate to active task (last task)
  if(p.tasks.length){
    p.tasks[p.tasks.length-1].effActual+=diff;
  }
  saveData();
  render();
},1000);

/* ---------- EXPORT CSV ---------- */
function exportCSV(){
  let rows=["Project,Task,Type,Est(m),Actual(m)"];

  data.forEach(p=>{
    let type=p.totalSeconds>p.allocatedSeconds?"OT":"Formal";
    if(p.tasks.length){
      p.tasks.forEach(t=>{
        rows.push(`${p.name},${t.name},${type},${Math.round(t.effEst/60)},${Math.round(t.effActual/60)}`);
      });
    } else {
      rows.push(`${p.name},(no task),${type},0,${Math.round((p.totalSeconds-p.remainingSeconds)/60)}`);
    }
  });

  rows.push("");
  rows.push("Pause Logs");
  pauseLogs.forEach(l=>{
    rows.push(`PAUSE,${l.type},${l.date},${Math.round(l.durationSec/60)}m`);
  });

  let blob=new Blob([rows.join("\n")],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url; a.download="ef_report.csv";
  a.click();
}

/* ---------- RENDER ---------- */
function render(){
  let box=document.getElementById("projects");
  box.innerHTML="";
  data.forEach(p=>{
    let card=document.createElement("div");
    card.className="project";

    let hdr=document.createElement("div");
    hdr.className="header";

    let left=document.createElement("div");
    let logo=document.createElement("div");
    logo.className="logo";
    if(p.logo){
      let img=document.createElement("img");
      img.src=p.logo;
      logo.appendChild(img);
    } else logo.textContent=p.name.charAt(0);

    let name=document.createElement("span");
    name.className="pname";
    name.textContent=p.name + " ("+p.allocation+"%)";

    left.appendChild(logo);
    left.appendChild(name);

    let btns=document.createElement("div");

    let start=document.createElement("button");
    start.className="btn-dark";
    start.textContent= activeProjectId===p.id ? "Running‚Ä¶" : "Start";
    start.onclick=()=>startProject(p.id);

    let del=document.createElement("button");
    del.className="btn-red";
    del.textContent="X";
    del.onclick=()=>deleteProject(p.id);

    btns.appendChild(start);
    btns.appendChild(del);

    hdr.appendChild(left);
    hdr.appendChild(btns);

    let timer=document.createElement("div");
    timer.className="timer";
    timer.style.color=p.remainingSeconds < p.totalSeconds*0.1 ? "#ffb347": var(--spotify-green);
    timer.textContent=fmt(p.remainingSeconds);

    let tasks=document.createElement("div");
    tasks.className="task-box";
    tasks.innerHTML=`<div style="font-size:11px;color:#999;margin-bottom:6px;">Tasks</div>
      <div>
        <input id="task_${p.id}" style="width:60%;margin-right:4px;font-size:11px;padding:4px;border-radius:8px;background:#000;color:#fff" placeholder="T√™n task"/>
        <input id="est_${p.id}" style="width:20%;margin-right:4px;font-size:11px;padding:4px;border-radius:8px;background:#000;color:#fff" placeholder="Est(m)"/>
        <button class="btn-green" style="font-size:11px;padding:4px" onclick="addTask('${p.id}')">+</button>
      </div>`;

    p.tasks.forEach(t=>{
      let row=document.createElement("div");
      row.className="task-row";
      row.innerHTML=`<span>${t.name} (${Math.round(t.effEst/60)}m est)</span>
           <button class="btn-red" style="font-size:10px;padding:2px 6px" onclick="deleteTask('${p.id}','${t.id}')">Del</button>`;
      tasks.appendChild(row);
    });

    card.appendChild(hdr);
    card.appendChild(timer);
    card.appendChild(tasks);

    box.appendChild(card);
  });
}
render();
</script>

</body>
</html>
